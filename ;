use std::net::SocketAddrV4;

use axum::Router;
use axum::middleware::from_fn_with_state;
use axum::routing;
use tokio::net::TcpListener;
use utoipa::OpenApi;
use utoipa_swagger_ui::SwaggerUi;

mod health;
mod middleware;
mod result;

use crate::http::middleware::authorization::authorization_middleware;
use crate::openapi::OpenApiDoc;
use crate::state::AppState;

async fn init_router(app_state: &AppState) -> anyhow::Result<Router> {
    let health_router = Router::new().route("/check", routing::get(health::health_check));

    let document_router =
        SwaggerUi::new("/docs/swagger-ui").url("/docs/openapi.json", OpenApiDoc::openapi());

    let api_router = Router::new()
        .nest("health", health_router)
        .merge(document_router)
        .route_layer(from_fn_with_state(
            app_state.clone(),
            authorization_middleware,
        ));

    let router = Router::new()
        .nest("/api", api_router)
        .with_state(app_state.clone());

    Ok(router)
}

async fn bind_addr(host: &str, port: u16) -> anyhow::Result<TcpListener> {
    let addr: SocketAddrV4 = format!("{}:{}", host, port)
        .parse()
        .map_err(|err| anyhow::anyhow!("Error when parsing listening address: {}", err))?;

    let listener = TcpListener::bind(&addr)
        .await
        .map_err(|err| anyhow::anyhow!("Error when binding to address {}: {}", addr, err))?;

    tracing::debug!("Server now listening on {}", addr);

    Ok(listener)
}

async fn signal_term() {
    tracing::debug!("SIGNAL TERM receiver installed");

    tokio::signal::ctrl_c()
        .await
        .expect("Failed to install CTRL-C signal handler");

    tracing::debug!("SIGNAL TERM received, shutting down gracefully...");
}

pub async fn run_server(app_state: &AppState) -> anyhow::Result<()> {
    // Initialize tokio TCP listener.
    let server_host = &app_state.config().server_host;
    let server_port = app_state.config().server_port;

    let listener = bind_addr(server_host, server_port).await?;

    // Initialize make service on router.
    let router = init_router(app_state).await?;

    axum::serve(listener, router)
        .with_graceful_shutdown(signal_term())
        .await
        .map_err(|err| anyhow::anyhow!("Error running server: {}", err))?;

    Ok(())
}
